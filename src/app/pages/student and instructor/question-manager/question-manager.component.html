<div class="layout-row">
  <aside class="sidebar" role="complementary" aria-label="Sidebar navigation">
    <app-sidebar-wrapper></app-sidebar-wrapper>
  </aside>

  <div class="main-content">
    <!-- Profile component -->
    <div class="profile-header">
      <app-profile [username]="username" [role]="getDisplayRole(userRole)" [avatarUrl]="avatarUrl"
        (profileUpdate)="onProfileUpdate()" (logout)="onLogout()">
      </app-profile>
    </div>

    <main>
      <div class="content-wrapper">
        <div class="course-content">
          <div class="question-manager-container">

            <!-- Header with question navigation -->
            <div class="question-header">
              <div class="title-section">
                <div class="title-group">
                  <h2>Quản lý câu hỏi - {{ quizTitle }}</h2>
                  <span class="quiz-type-badge" [class]="quizType.toLowerCase()">
                    {{ quizType === 'MULTIPLE_CHOICE' ? 'Trắc nghiệm' : 'Tự luận' }}
                  </span>
                </div>
                
                <div class="header-actions">
                  <!-- Multi-select toggle button -->
                  <button 
                    class="multi-select-btn"
                    [class.active]="isMultiSelectMode"
                    (click)="toggleMultiSelectMode()"
                    title="Chọn nhiều câu hỏi để xóa">
                    <i class="fas fa-check-square" *ngIf="isMultiSelectMode"></i>
                    <i class="fas fa-square" *ngIf="!isMultiSelectMode"></i>
                    Chọn nhiều
                  </button>
                  
                  <!-- Bulk action buttons (show only in multi-select mode) -->
                  <div class="bulk-actions" *ngIf="isMultiSelectMode">
                    <button 
                      class="bulk-action-btn select-all"
                      (click)="selectAllQuestions()"
                      [disabled]="selectedQuestionIds.size === questions.length">
                      <i class="fas fa-check-double"></i>
                      Chọn tất cả
                    </button>
                    <button 
                      class="bulk-action-btn deselect-all"
                      (click)="deselectAllQuestions()"
                      [disabled]="selectedQuestionIds.size === 0">
                      <i class="fas fa-times"></i>
                      Bỏ chọn
                    </button>
                    <button 
                      class="bulk-action-btn delete-selected"
                      (click)="deleteSelectedQuestions()"
                      [disabled]="selectedQuestionIds.size === 0">
                      <i class="fas fa-trash"></i>
                      Xóa đã chọn ({{ selectedQuestionIds.size }})
                    </button>
                  </div>
                </div>
              </div>

              <!-- Question tabs -->
              <div class="question-tabs">
                <div class="question-tab-container"
                  *ngFor="let question of questions; let i = index">
                  
                  <!-- Multi-select checkbox -->
                  <div class="question-checkbox" *ngIf="isMultiSelectMode">
                    <input 
                      type="checkbox" 
                      [id]="'select-' + i"
                      [checked]="isQuestionSelected(i)"
                      (change)="toggleQuestionSelection(i)"
                      class="question-select-checkbox">
                  </div>
                  
                  <!-- Question tab -->
                  <button class="question-tab"
                    [class.active]="currentQuestionIndex === i" 
                    [class.editing]="currentQuestionIndex === i && isEditing"
                    [class.selected]="isQuestionSelected(i)"
                    (click)="switchToQuestion(i)" 
                    title="Question {{ i + 1 }}">
                    {{ i + 1 }}
                    <button class="delete-btn" 
                      (click)="deleteQuestion(i); $event.stopPropagation()" 
                      title="Xóa câu hỏi"
                      *ngIf="!(quizType === 'ESSAY' && questions.length === 1) && !isMultiSelectMode">
                      <i class="fas fa-times"></i>
                    </button>
                  </button>
                </div>

                <button class="add-question-btn" 
                  (click)="addNewQuestion()" 
                  title="Thêm câu hỏi mới"
                  *ngIf="quizType === 'MULTIPLE_CHOICE' && !isMultiSelectMode">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>

            <!-- Question form -->
            <div class="question-form">
              <div class="question-info">
                <div class="question-header-row">
                  <h3>
                    <span *ngIf="quizType === 'MULTIPLE_CHOICE'">
                      {{ isEditing ? 'Câu hỏi ' + (currentQuestionIndex + 1) : 'Câu hỏi mới' }}
                    </span>
                    <span *ngIf="quizType === 'ESSAY'">
                      {{ isEditing ? 'Đề bài' : 'Đề bài mới' }}
                    </span>
                    <span class="question-status" *ngIf="isEditing">
                      <i class="fas fa-edit"></i> Đang chỉnh sửa
                    </span>
                  </h3>
                  
                  <div class="points-input">
                    <label for="points">Điểm *</label>
                    <input type="number" id="points" name="points" [(ngModel)]="currentQuestion.points"
                      (ngModelChange)="onQuestionContentChange()" min="0.5" max="100" step="0.5" required>
                  </div>
                </div>
              </div>

              <form autocomplete="off" novalidate>
                <!-- Question Text -->
                <div class="form-group">
                  <label for="question-text">Nội dung câu hỏi *</label>

                  <!-- Rich text toolbar for essay questions -->
                  <div class="rich-text-toolbar" *ngIf="currentQuestion.questionType === 'ESSAY'">
                    <div class="toolbar-group">
                      <button type="button" class="toolbar-btn" (click)="formatText('bold')" title="Bold">
                        <i class="fas fa-bold"></i>
                      </button>
                      <button type="button" class="toolbar-btn" (click)="formatText('italic')" title="Italic">
                        <i class="fas fa-italic"></i>
                      </button>
                      <button type="button" class="toolbar-btn" (click)="formatText('underline')" title="Underline">
                        <i class="fas fa-underline"></i>
                      </button>
                    </div>
                    <div class="toolbar-group">
                      <select class="font-size-select">
                        <option value="12">12px</option>
                        <option value="14" selected>14px</option>
                        <option value="16">16px</option>
                        <option value="18">18px</option>
                        <option value="20">20px</option>
                        <option value="24">24px</option>
                      </select>
                    </div>
                    <div class="toolbar-group">
                      <button type="button" class="toolbar-btn" title="Attach File"
                        (click)="fileInput?.nativeElement.click()">
                        <i class="fas fa-paperclip"></i>
                      </button>
                    </div>
                  </div>

                  <textarea #questionTextArea id="question-text" name="questionText"
                    [(ngModel)]="currentQuestion.questionText" (ngModelChange)="onQuestionContentChange()"
                    placeholder="Nhập nội dung câu hỏi..."
                    [class]="currentQuestion.questionType === 'ESSAY' ? 'rich-text-area' : 'simple-text-area'" rows="6"
                    required>
                    </textarea>

                  <!-- File attachment for essay questions -->
                  <div class="file-attachment" *ngIf="currentQuestion.questionType === 'ESSAY'">
                    <input #fileInput type="file" (change)="onFileSelected($event)" accept="image/*,.pdf,.doc,.docx"
                      style="display: none;">

                    <!-- Show selected file -->
                    <div class="attachment-info" *ngIf="selectedFile">
                      <i class="fas fa-file"></i>
                      <span>{{ selectedFile.name }}</span>
                      <button type="button" class="remove-file" (click)="selectedFile = null">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>

                    <!-- Show existing file -->
                    <div class="attachment-info existing-file" *ngIf="!selectedFile && currentQuestion.questionFileUrl">
                      <i class="fas fa-file-alt"></i>
                      <span>{{ currentQuestion.questionFileName }}</span>
                      <a [href]="'http://localhost:8080' + currentQuestion.questionFileUrl" target="_blank"
                        class="download-link" title="Tải về file">
                        <i class="fas fa-download"></i>
                      </a>
                      <button type="button" class="remove-file" (click)="removeExistingFile()">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Multiple Choice Options -->
                <div class="form-group" *ngIf="currentQuestion.questionType === 'MULTIPLE_CHOICE'">
                  <div class="options-header">
                    <label>Các lựa chọn * (chọn 1 đáp án đúng)</label>
                    <button type="button" class="add-option-btn" (click)="addOption()"
                      [disabled]="currentQuestion.options!.length >= 6">
                      <i class="fas fa-plus"></i> Thêm lựa chọn
                    </button>
                  </div>
                  <div class="options-container">
                    <div class="option-item"
                      *ngFor="let option of currentQuestion.options; let i = index; trackBy: trackByIndex">
                      <div class="option-input-group">
                        <input type="radio" [id]="'correct-' + i" [value]="i" 
                          [(ngModel)]="selectedCorrectAnswerIndex"
                          (ngModelChange)="onCorrectAnswerChange(i)" 
                          [name]="'correctAnswer'"
                          class="correct-radio" title="Tích chọn để đánh dấu đây là đáp án đúng">

                        <input type="text" [(ngModel)]="currentQuestion.options![i]"
                          (ngModelChange)="onQuestionContentChange()" [name]="'option' + i"
                          [placeholder]="'Lựa chọn ' + (i + 1)" class="option-input">

                        <button type="button" class="remove-option-btn" (click)="removeOption(i)"
                          [disabled]="currentQuestion.options!.length <= 2" title="Xóa lựa chọn">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>


              </form>
            </div>

            <!-- Final actions -->
            <div class="final-actions">
              <div class="questions-summary">
                <span class="total-questions">Tổng cộng: <strong>{{ questions.length }}</strong> câu hỏi</span>
              </div>

              <div class="action-buttons">
                <button type="button" class="btn cancel modern-btn" (click)="cancelQuestions()">Hủy</button>
                <button type="button" class="btn save-all modern-btn" (click)="saveAllQuestions()" [disabled]="isSaving">
                  <i class="fas fa-check"></i>
                  {{ isSaving ? 'Đang lưu tất cả...' : 'Hoàn thành và lưu tất cả' }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Confirm Modal -->
<div class="modal-overlay" *ngIf="showConfirmModal" (click)="onConfirmModalCancel()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ confirmModalTitle }}</h3>
      <button class="modal-close" (click)="onConfirmModalCancel()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="modal-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <p>{{ confirmModalMessage }}</p>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="onConfirmModalCancel()">Hủy</button>
      <button class="btn-confirm" (click)="onConfirmModalOk()">Tiếp tục</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteModal" (click)="onDeleteModalCancel()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ deleteModalTitle }}</h3>
      <button class="modal-close" (click)="onDeleteModalCancel()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="modal-icon delete-icon">
        <i class="fas fa-trash-alt"></i>
      </div>
      <p>{{ deleteModalMessage }}</p>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="onDeleteModalCancel()">Hủy</button>
      <button class="btn-delete" (click)="onDeleteModalOk()">Xóa</button>
    </div>
  </div>
</div>

<!-- Notification Component -->
<app-notification></app-notification>